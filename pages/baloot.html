<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù‚ÙŠØ¯ Ø§Ù„Ø¨Ù„ÙˆØª</title>
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <div class="app" data-theme="dark">
    <header class="topbar">
      <div class="brand">
        <div class="logo logo-sm">
          <div class="logo-placeholder">LOGO</div>
        </div>
        <div class="brand-text">
          <div class="brand-title">Ù‚ÙŠØ¯ Ø§Ù„Ø¨Ù„ÙˆØª</div>
          <div class="brand-sub">ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ù„ÙŠ â€” Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨</div>
        </div>
      </div>

      <button class="icon-btn" id="themeToggle" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…">
        <span class="icon" id="themeIcon">ğŸŒ™</span>
      </button>
    </header>

    <main class="container">
      <div class="toolbar">
        <button class="small-btn" id="homeBtn" type="button">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="small-btn" id="undoBtn" type="button">ØªØ±Ø§Ø¬Ø¹</button>
        <div class="center-title">Ù‚ÙŠØ¯ Ø§Ù„Ø¨Ù„ÙˆØª</div>
        <button class="small-btn" id="newGameTopBtn" type="button">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>

      <div class="banner" id="endBanner">
        <div id="endMessage"></div>
        <div class="end-actions">
          <button class="btn btn-ok" id="endNewGameBtn" type="button">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="btn" id="endHomeBtn" type="button">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
      </div>

      <section class="panel">
        <div class="inputs">
          <div class="side">
            <div class="side-title">Ù„Ù†Ø§</div>
            <input class="input" id="usInput" inputmode="tel" autocomplete="off" placeholder="0" />
            <div class="help">ØªÙ‚Ø¯Ø± ØªØ³Ø¬Ù„ Ù„Ù†Ø§ Ø£Ùˆ Ù„Ù‡Ù… Ø£Ùˆ Ø§Ù„Ø§Ø«Ù†ÙŠÙ†. Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø³ Ø¨Ø²Ø± â€œØ³Ø¬Ù„â€.</div>
          </div>

          <div class="side">
            <div class="side-title">Ù„Ù‡Ù…</div>
            <input class="input" id="themInput" inputmode="tel" autocomplete="off" placeholder="0" />
            <div class="help">Ø¥Ø°Ø§ Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ† ØªØ¹Ø¯Ù‘ÙˆØ§ 152 ÙˆØªØ¹Ø§Ø¯Ù„ÙˆØ§ØŒ Ù†ÙƒÙ…Ù„ Ù„ÙŠÙ† ÙˆØ§Ø­Ø¯ ÙŠØªØ¹Ø¯Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠ.</div>
          </div>
        </div>

        <div style="margin-top: 12px;">
          <button class="btn" id="saveBtn" type="button">Ø³Ø¬Ù„</button>
        </div>
      </section>

      <section class="panel">
        <div class="logs">
          <div class="log-col">
            <div class="log-title">Ø³Ø¬Ù„ Ù„Ù†Ø§</div>
            <div class="log-list" id="usLog"></div>
          </div>

          <div class="log-col">
            <div class="log-title">Ø³Ø¬Ù„ Ù„Ù‡Ù…</div>
            <div class="log-list" id="themLog"></div>
          </div>
        </div>

        <div class="totals">
          <div class="total-box">
            <div class="total-label">Ù…Ø¬Ù…ÙˆØ¹ Ù„Ù†Ø§</div>
            <div class="total-value" id="usTotal">0</div>
          </div>

          <div class="total-box">
            <div class="total-label">Ù…Ø¬Ù…ÙˆØ¹ Ù„Ù‡Ù…</div>
            <div class="total-value" id="themTotal">0</div>
          </div>
        </div>

        <div class="btn-row" style="margin-top: 12px;">
          <button class="btn btn-danger" id="clearAllBtn" type="button">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
        </div>
      </section>
    </main>
  </div>

  <script src="../app.js"></script>
  <script>
    (function () {
      const STORAGE_KEY = "qaid_baloot_v2";
      const HISTORY_KEY = "qaid_baloot_history_v2";
      const WIN_SCORE = 152;

      // Ù†ØµÙˆØµ Ø§Ù„ØªØ£ÙƒÙŠØ¯ (Ù…Ù† Ø³Ø¹ÙˆØ¯)
      const CONFIRM_UNDO = "Ù…ØªØ£ÙƒØ¯ ØªØ¨ÙŠ ØªØªØ±Ø§Ø¬Ø¹ ØŸ";
      const CONFIRM_NEW  = "Ù…ØªØ£ÙƒØ¯ ØªØ¨ÙŠ ØªØ¨Ø¯Ø£ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø© ØŸ";
      const CONFIRM_CLEAR= "Ù…ØªØ£ÙƒØ¯ ØªØ¨ÙŠ ØªÙ…Ø³Ø­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ØŸ";
      const CONFIRM_HOME = "Ù…ØªØ£ÙƒØ¯ ØªØ¨ÙŠ ØªØ±Ø¬Ø¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ØŸ";

      // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
      const MSG_WIN_US   = "Ù…Ø¨Ø±ÙˆÙƒ ÙÙˆØ² !";
      const MSG_WIN_THEM = "Ø®Ø³Ø§Ø±Ø© !";

      const usInput = document.getElementById("usInput");
      const themInput = document.getElementById("themInput");
      const saveBtn = document.getElementById("saveBtn");

      const undoBtn = document.getElementById("undoBtn");
      const newGameTopBtn = document.getElementById("newGameTopBtn");
      const clearAllBtn = document.getElementById("clearAllBtn");
      const homeBtn = document.getElementById("homeBtn");

      const endBanner = document.getElementById("endBanner");
      const endMessage = document.getElementById("endMessage");
      const endNewGameBtn = document.getElementById("endNewGameBtn");
      const endHomeBtn = document.getElementById("endHomeBtn");

      const usLog = document.getElementById("usLog");
      const themLog = document.getElementById("themLog");
      const usTotalEl = document.getElementById("usTotal");
      const themTotalEl = document.getElementById("themTotal");

      function freshState() {
        return { us: [], them: [], locked: false, winner: null };
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return freshState();
          const p = JSON.parse(raw);
          return {
            us: Array.isArray(p.us) ? p.us : [],
            them: Array.isArray(p.them) ? p.them : [],
            locked: !!p.locked,
            winner: p.winner || null
          };
        } catch {
          return freshState();
        }
      }

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      function loadHistory() {
        try {
          const raw = localStorage.getItem(HISTORY_KEY);
          if (!raw) return [];
          const arr = JSON.parse(raw);
          return Array.isArray(arr) ? arr : [];
        } catch {
          return [];
        }
      }

      function saveHistory() {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
      }

      function sum(arr) {
        let s = 0;
        for (const n of arr) s += n;
        return s;
      }

      // ÙŠØ­ÙˆÙ„ Ù¡Ù¢Ù£/Û±Û²Û³ Ø¥Ù„Ù‰ 123 ÙˆÙŠØ´ÙŠÙ„ Ø£ÙŠ Ø´ÙŠ Ù…Ùˆ Ø±Ù‚Ù…
      function toWesternDigits(str) {
        if (str == null) return "";
        const map = {
          'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9',
          'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'
        };
        let out = "";
        for (const ch of String(str)) {
          if (ch >= '0' && ch <= '9') out += ch;
          else if (map[ch] != null) out += map[ch];
        }
        return out;
      }

      function sanitizeNumber(value) {
        const digits = toWesternDigits(value).trim();
        if (digits === "") return null;
        const n = Number(digits);
        if (!Number.isFinite(n)) return null;
        return n;
      }

      function setEndUI() {
        if (state.winner) {
          endBanner.classList.add("show");
          endMessage.textContent = state.winner === "us" ? MSG_WIN_US : MSG_WIN_THEM;
        } else {
          endBanner.classList.remove("show");
          endMessage.textContent = "";
        }
      }

      function render() {
        usLog.innerHTML = "";
        themLog.innerHTML = "";

        state.us.forEach((n) => {
          const item = document.createElement("div");
          item.className = "log-item";
          item.textContent = String(n); // Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
          usLog.appendChild(item);
        });

        state.them.forEach((n) => {
          const item = document.createElement("div");
          item.className = "log-item";
          item.textContent = String(n); // Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
          themLog.appendChild(item);
        });

        const usTotal = sum(state.us);
        const themTotal = sum(state.them);

        usTotalEl.textContent = String(usTotal);
        themTotalEl.textContent = String(themTotal);

        saveBtn.disabled = state.locked;
        undoBtn.disabled = history.length === 0;

        setEndUI();

        usInput.value = "";
        themInput.value = "";
      }

      function checkWin() {
        const usTotal = sum(state.us);
        const themTotal = sum(state.them);

        if (usTotal < WIN_SCORE && themTotal < WIN_SCORE) {
          state.locked = false;
          state.winner = null;
          return;
        }

        if (usTotal >= WIN_SCORE && themTotal < WIN_SCORE) {
          state.locked = true;
          state.winner = "us";
          return;
        }
        if (themTotal >= WIN_SCORE && usTotal < WIN_SCORE) {
          state.locked = true;
          state.winner = "them";
          return;
        }

        // Ø§Ù„Ø§Ø«Ù†ÙŠÙ† ØªØ¹Ø¯Ù‘ÙˆØ§
        if (usTotal === themTotal) {
          // ØªØ¹Ø§Ø¯Ù„: Ù†ÙƒÙ…Ù„
          state.locked = false;
          state.winner = null;
          return;
        }

        state.locked = true;
        state.winner = usTotal > themTotal ? "us" : "them";
      }

      function recordHistory(entry) {
        history.push(entry);
        if (history.length > 300) history.shift();
        saveHistory();
      }

      function onSave() {
        if (state.locked) return;

        const usVal = sanitizeNumber(usInput.value);
        const themVal = sanitizeNumber(themInput.value);

        if (usVal == null && themVal == null) return;

        recordHistory({ usAdded: usVal != null, themAdded: themVal != null });

        if (usVal != null) state.us.push(usVal);
        if (themVal != null) state.them.push(themVal);

        checkWin();
        saveState();
        render();
      }

      function onUndo() {
        if (history.length === 0) return;
        if (!confirm(CONFIRM_UNDO)) return;

        const last = history.pop();
        saveHistory();

        if (last.usAdded && state.us.length > 0) state.us.pop();
        if (last.themAdded && state.them.length > 0) state.them.pop();

        state.locked = false;
        state.winner = null;
        checkWin();

        saveState();
        render();
      }

      function newGame(confirmText) {
        if (!confirm(confirmText)) return;
        state = freshState();
        history = [];
        saveState();
        saveHistory();
        render();
      }

      function goHome() {
        if (!confirm(CONFIRM_HOME)) return;
        window.location.href = "../index.html";
      }

      // Events
      saveBtn.addEventListener("click", onSave);

      undoBtn.addEventListener("click", onUndo);

      newGameTopBtn.addEventListener("click", () => {
        // Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨ = ØªØ£ÙƒÙŠØ¯ (Ø±Ù‚Ù… 2)
        newGame(CONFIRM_NEW);
      });

      clearAllBtn.addEventListener("click", () => {
        // Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ = ØªØ£ÙƒÙŠØ¯ (Ø±Ù‚Ù… 3)
        newGame(CONFIRM_CLEAR);
      });

      homeBtn.addEventListener("click", goHome);

      // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©: Ø²Ø±Ù‘ÙŠÙ† Ø¨Ø¯ÙˆÙ† Ù„Ù ÙˆØ¯ÙˆØ±Ø§Ù† (Ø¨Ø³ Ø¨Ù†ÙØ³ Ø§Ù„ØªØ£ÙƒÙŠØ¯Ø§Øª)
      endNewGameBtn.addEventListener("click", () => newGame(CONFIRM_NEW));
      endHomeBtn.addEventListener("click", goHome);

      // Ù†Ø¶Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¨Ù‚Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· (Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)
      function bindNumericOnly(inputEl) {
        inputEl.addEventListener("input", () => {
          const v = inputEl.value;
          const cleaned = toWesternDigits(v);
          if (v !== cleaned) inputEl.value = cleaned;
        });
      }
      bindNumericOnly(usInput);
      bindNumericOnly(themInput);

      let state = loadState();
      let history = loadHistory();
      render();
    })();
  </script>
</body>
</html>
